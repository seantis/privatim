<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:metal="http://xml.zope.org/namespaces/metal"
         i18n:domain="privatim">

<!-- 'Add comment' component. -->
<metal:block define-macro="add_comment_form">
    <div class="card border-0">
        <form enctype="multipart/form-data" method="POST" action="${add_comment_route_name}">
            <input type="hidden" name="csrf_token" value="${layout.csrf_token()}"/>
            <div class="d-flex">
                <img class="rounded-circle shadow-1-strong me-3"
                     src="${request.profile_pic}"
                     alt="avatar"
                     height="40"
                     width="40"
                />
                <div class="flex-grow-1">
                    <div class="comment-input-field">
                    ${form.content(placeholder=" ")}
                        <span i18n:translate="">Message</span>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end mt-2 pt-1">
                    ${form.submit()}
            </div>
        </form>
</metal:block>


<!-- 'Add comment' component but if answering a nested comment -->
<metal:block define-macro="answer_comment_form">
    <div class="mt-4">
        <div class="card border-0">
            <form enctype="multipart/form-data" method="POST" action="${add_comment_route_name}">
                <input type="hidden" name="csrf_token" value="${layout.csrf_token()}"/>
                <div class="ms-5 d-flex">
                    <img class="rounded-circle shadow-1-strong me-3"
                         src="${request.profile_pic}"
                         alt="avatar"
                         width="40"
                         height="40"
                    />
                    <div class="flex-grow-1">
                        <div class="comment-input-field input-field-answer-comment">
                        ${form.content(placeholder=" ")}
                            <span i18n:translate="">Message</span>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-end mt-2 pt-1">
                        ${form.submit()}
                </div>
            </form>
        </div>
    </div>
</metal:block>


<!-- Render all the comments. -->
<metal:block define-macro="display_comments">
    <div tal:condition="flattened_comments_tree" tal:repeat="flattened_comment flattened_comments_tree" class="consultation-main-text">
        <div class="card border-0">
            <div class="card-body">
                <div class="d-flex flex-start align-items-center">
                    <img class="rounded-circle shadow-1-strong me-3 comment-picture"
                         src="${flattened_comment['picture']}"
                         alt="avatar"
                         width="60"
                         height="60"
                    />
                    <div>
                        <h6 class="fw-bold text-primary mb-1">
                            <a href="${request.route_url('person', id=flattened_comment['comment'].user.id)}">${flattened_comment['comment'].user.fullname or flattened_comment['comment'].user.email}</a>
                        </h6>
                        <p class="text-muted small mb-0">
                                ${layout.format_date(flattened_comment['comment'].created, 'relative')}
                        </p>
                    </div>
                </div>
                <p class="comment-text mb-3 mt-1">
                        ${flattened_comment['comment'].content}
                </p>
                <div class="answer-button small d-flex">
                    <a href="#!" class="d-flex align-items-center me-3 comment-answer-button">
                        <i class="far fa-comment-dots me-2"></i>
                        <p i18n:translate="" class="mb-0">Answer</p>
                    </a>
                </div>
                <!--? Answer for a top-level comment  -->
            </div>
            <div class="row comment-answer-form-container">
                <metal:block use-macro="layout.macros['answer_comment_form']"
                         tal:define="add_comment_route_name request.route_url('add_comment', id=consultation.id,
                                _query={'target_url': 'consultation',
                                        'parent_id': flattened_comment['comment'].id});
                                form nested_comment_form">
                </metal:block>
            </div>
        </div>

        <!-- Display children comments -->
        <div class="indent-child-comments"
                tal:repeat="child_comment_dict flattened_comment['children']">
            <div class="card border-0" tal:define="comment child_comment_dict['comment']; picture child_comment_dict['picture']">
                <div class="card-body">
                    <div class="d-flex flex-start align-items-center">
                        <img class="rounded-circle shadow-1-strong me-3"
                             src="${picture}"
                             alt="avatar"
                             width="60"
                             height="60"
                        />
                        <div>
                            <h6 class="fw-bold text-primary mb-1">
                                <a href="${request.route_url('person', id=comment.user.id)}">
                                        ${comment.user.fullname or comment.user.email}</a>
                            </h6>
                            <p class="text-muted small mb-0">
                                    ${layout.format_date(comment.created, 'relative')}
                            </p>
                        </div>
                    </div>
                    <p class="comment-text mb-3 mt-1">
                            ${comment.content}
                    </p>
                    <div class="answer-button small d-flex">
                        <a href="#!" class="d-flex align-items-center me-3 comment-answer-button">
                            <i class="far fa-comment-dots me-2"></i>
                            <p i18n:translate="" class="mb-0">Answer</p>
                        </a>
                    </div>
                </div>
                <!--? Answer for a child comment  -->
                <div class="row comment-answer-form-container">
                    <metal:block use-macro="layout.macros['answer_comment_form']"
                             tal:define="add_comment_route_name request.route_url('add_comment', id=consultation.id,
                                    _query={'target_url': 'consultation',
                                            'parent_id': flattened_comment['comment'].id});
                                    form nested_comment_form">
                    </metal:block>
                </div>
            </div>

        </div>
        <!-- Slightly more bold divider line-->
        <hr class="border-2 "/>

    </div> <!--?  tal repeat end -->
</metal:block>


<tal:block metal:define-macro="search_form">
    <div class="container">
        <form enctype="multipart/form-data" method="POST" action="${action}" novalidate
              class="col-12 col-lg-auto mb-3 mb-lg-0 me-lg-3 d-flex align-items-center" id="search">
            <input type="hidden" name="csrf_token" value="${layout.csrf_token()}"/>
            <input type="text" name="term" autocomplete="off" class="form-control" placeholder="Search..."/>
            <button type="submit" class="btn btn-secondary" id="search-button"><i class="fa fa-search"></i></button>
        </form>
    </div>
</tal:block>

</html>
